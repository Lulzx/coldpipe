{% extends "base.html" %}
{% block title %}{{ campaign.name }} - Coldpipe{% endblock %}
{% block content %}
<div class="page-header d-print-none mb-3">
  <div class="row align-items-center">
    <div class="col">
      <a href="/campaigns" class="text-muted mb-1 d-block">&#8592; Back to campaigns</a>
      <h2 class="page-title">{{ campaign.name }}</h2>
      <div class="text-muted mt-1">
        {% if campaign.status == 'active' %}
        <span class="badge bg-green-lt">active</span>
        {% elif campaign.status == 'paused' %}
        <span class="badge bg-yellow-lt">paused</span>
        {% else %}
        <span class="badge bg-secondary-lt">{{ campaign.status }}</span>
        {% endif %}
      </div>
    </div>
    <div class="col-auto d-flex gap-2">
      {% if campaign.status == 'active' %}
      <form method="post" action="/campaigns/{{ campaign.id }}/pause">
        <button type="submit" class="btn btn-warning">Pause</button>
      </form>
      {% elif campaign.status == 'paused' or campaign.status == 'draft' %}
      <form method="post" action="/campaigns/{{ campaign.id }}/resume">
        <button type="submit" class="btn btn-success">Resume</button>
      </form>
      {% endif %}
      <form method="post" action="/campaigns/{{ campaign.id }}/delete" onsubmit="return confirm('Delete this campaign? This cannot be undone.')">
        <button type="submit" class="btn btn-outline-danger">Delete</button>
      </form>
    </div>
  </div>
</div>

<div class="row row-deck row-cards mb-3">
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <div class="subheader">Enrolled</div>
        <div class="h1 mb-0">{{ stats.get('total', 0) }}</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <div class="subheader">Active</div>
        <div class="h1 mb-0">{{ stats.get('active', 0) }}</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <div class="subheader">Replied</div>
        <div class="h1 mb-0 text-green">{{ stats.get('replied', 0) }}</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <div class="subheader">Bounced</div>
        <div class="h1 mb-0 text-red">{{ stats.get('bounced', 0) }}</div>
      </div>
    </div>
  </div>
</div>

{% if steps %}
<div class="card mb-3">
  <div class="card-header">
    <h3 class="card-title">Sequence Flow</h3>
  </div>
  <div class="card-body">
    <ul class="steps steps-counter steps-blue">
      {% for s in steps %}
      <li class="step-item">{{ s.template_name }}{% if s.delay_days %} ({{ s.delay_days }}d){% endif %}</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<div class="card mb-3">
  <div class="card-header">
    <h3 class="card-title">Sequence Steps</h3>
  </div>
  <div class="table-responsive">
    <table class="table table-vcenter card-table">
      <thead>
        <tr>
          <th>Step</th>
          <th>Template</th>
          <th>Subject</th>
          <th>Delay (days)</th>
          <th>Reply?</th>
        </tr>
      </thead>
      <tbody>
        {% for s in steps %}
        <tr>
          <td>{{ s.step_number }}</td>
          <td>{{ s.template_name }}</td>
          <td>{{ s.subject }}</td>
          <td>{{ s.delay_days }}</td>
          <td>{{ 'Yes' if s.is_reply else 'No' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5">
            <div class="empty py-3">
              <p class="empty-title">No steps configured</p>
              <p class="empty-subtitle text-muted">Add sequence steps via CLI.</p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if step_dist %}
<div class="card mb-3">
  <div class="card-header">
    <h3 class="card-title">Lead Distribution by Step</h3>
  </div>
  <div class="card-body">
    <div id="chart-step-dist" style="height: 260px;"></div>
  </div>
</div>
{% endif %}

<div class="card">
  <div class="card-header">
    <h3 class="card-title">Enrolled Leads</h3>
  </div>
  <div class="table-responsive">
    <table class="table table-vcenter card-table">
      <thead>
        <tr>
          <th>Lead ID</th>
          <th>Step</th>
          <th>Status</th>
          <th>Enrolled</th>
          <th>Last Sent</th>
          <th>Next Send</th>
        </tr>
      </thead>
      <tbody>
        {% for cl in leads %}
        <tr>
          <td><a href="/leads/{{ cl.lead_id }}">{{ cl.lead_id }}</a></td>
          <td>{{ cl.current_step }}</td>
          <td>
            {% if cl.status == 'active' %}
            <span class="badge bg-green-lt">active</span>
            {% elif cl.status == 'replied' %}
            <span class="badge bg-blue-lt">replied</span>
            {% elif cl.status == 'bounced' %}
            <span class="badge bg-red-lt">bounced</span>
            {% else %}
            <span class="badge bg-secondary-lt">{{ cl.status }}</span>
            {% endif %}
          </td>
          <td>{{ cl.enrolled_at[:10] if cl.enrolled_at else '-' }}</td>
          <td>{{ cl.last_sent_at or '-' }}</td>
          <td>{{ cl.next_send_at or '-' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6">
            <div class="empty py-3">
              <p class="empty-title">No leads enrolled</p>
              <p class="empty-subtitle text-muted">Enroll leads via CLI to start sending.</p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
{% if step_dist %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var stepDist = {{ step_dist|tojson }};
  var stepNums = Object.keys(stepDist).map(Number).sort(function(a, b) { return a - b; });
  var categories = stepNums.map(function(s) { return 'Step ' + s; });

  var statuses = ['active', 'replied', 'bounced', 'completed', 'paused', 'unsubscribed'];
  var colorMap = { active: '#2fb344', replied: '#206bc4', bounced: '#d63939',
                   completed: '#6c757d', paused: '#f59f00', unsubscribed: '#ae3ec9' };
  var series = [];
  statuses.forEach(function(st) {
    var data = stepNums.map(function(s) { return (stepDist[s] || {})[st] || 0; });
    if (data.some(function(v) { return v > 0; })) {
      series.push({ name: st, data: data });
    }
  });

  if (series.length > 0) {
    new ApexCharts(document.querySelector('#chart-step-dist'), {
      chart: { type: 'bar', height: 260, stacked: true, fontFamily: 'inherit',
        toolbar: { show: false } },
      series: series,
      colors: series.map(function(s) { return colorMap[s.name] || '#6c757d'; }),
      xaxis: { categories: categories },
      plotOptions: { bar: { horizontal: false, borderRadius: 4 } },
      legend: { position: 'top' },
      grid: { strokeDashArray: 4 },
      dataLabels: { enabled: false }
    }).render();
  }
});
</script>
{% endif %}
{% endblock %}
