{% extends "base.html" %}
{% from "_macros/components.html" import status_badge, page_header, filter_select, empty_state %}
{% block title %}Emails - Coldpipe{% endblock %}
{% block content %}
{{ page_header("Sent Emails", total ~ " email" ~ ("s" if total != 1 else "")) }}

{% if email_dist %}
<div class="card mb-3">
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-4">
        <div id="chart-email-status" style="height: 200px;"></div>
      </div>
      <div class="col-md-8">
        <div class="row g-2">
          {% for st, cnt in email_dist.items() %}
          <div class="col-auto">
            <span class="badge {% if st == 'sent' or st == 'delivered' %}bg-blue-lt{% elif st == 'replied' %}bg-green-lt{% elif st == 'bounced' %}bg-red-lt{% elif st == 'failed' %}bg-orange-lt{% else %}bg-secondary-lt{% endif %} fs-6">{{ st }}: {{ cnt }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="card mb-3">
  <div class="card-body">
    {{ filter_select("status", ['sent', 'delivered', 'replied', 'bounced', 'failed'], status, "All statuses", "/emails") }}
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-vcenter card-table">
      <thead>
        <tr>
          <th>To</th>
          <th>Subject</th>
          <th>Status</th>
          <th>Campaign</th>
          <th>Step</th>
          <th>Sent At</th>
        </tr>
      </thead>
      <tbody>
        {% block table_body %}
        {% for e in emails %}
        <tr>
          <td>{{ e.to_email }}</td>
          <td>{{ e.subject }}</td>
          <td>{{ status_badge(e.status) }}</td>
          <td>{{ e.campaign_id or '-' }}</td>
          <td>{{ e.step_number }}</td>
          <td>{{ e.sent_at or '-' }}</td>
        </tr>
        {% else %}
        {{ empty_state("No emails sent yet", "Start a campaign to begin sending emails.", 6, '<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"/><path d="M3 7l9 6l9 -6"/></svg>') }}
        {% endfor %}
        {% endblock %}
      </tbody>
    </table>
  </div>
</div>

{% include "_partials/pagination.html" %}
{% endblock %}

{% block scripts %}
{% if email_dist %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var dist = {{ email_dist|tojson }};
  var labels = Object.keys(dist);
  var values = Object.values(dist);
  var colorMap = { sent: '#206bc4', delivered: '#206bc4', replied: '#2fb344',
                   bounced: '#d63939', failed: '#f76707' };
  var colors = labels.map(function(l) { return colorMap[l] || '#6c757d'; });

  new ApexCharts(document.querySelector('#chart-email-status'), {
    chart: { type: 'donut', height: 200, fontFamily: 'inherit' },
    series: values,
    labels: labels,
    colors: colors,
    legend: { position: 'bottom', fontSize: '12px' },
    plotOptions: { pie: { donut: { size: '55%' } } },
    dataLabels: { enabled: false }
  }).render();
});
</script>
{% endif %}
{% endblock %}
