{% extends "base.html" %}
{% block title %}Deals - Coldpipe{% endblock %}
{% block content %}
<div class="page-header d-print-none mb-3">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">Deals</h2>
      <div class="text-muted mt-1">
        Pipeline: ${{ "%.0f"|format(stats.pipeline_value) }} |
        Closed: ${{ "%.0f"|format(stats.closed_value) }}
      </div>
    </div>
    <div class="col-auto">
      <a href="/deals/pipeline" class="btn btn-outline-primary">Pipeline View</a>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <form method="get" action="/deals" class="d-flex gap-2">
      <select name="stage" class="form-select" style="max-width: 200px;" onchange="this.form.submit()">
        <option value="">All stages</option>
        {% for s in ['lead', 'contacted', 'replied', 'interested', 'meeting_booked', 'proposal_sent', 'closed_won', 'closed_lost'] %}
        <option value="{{ s }}"{% if stage == s %} selected{% endif %}>{{ s|replace('_', ' ')|title }}</option>
        {% endfor %}
      </select>
    </form>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-vcenter card-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Lead</th>
          <th>Stage</th>
          <th>Value</th>
          <th>Notes</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for d in deals %}
        <tr>
          <td>{{ d.id }}</td>
          <td><a href="/leads/{{ d.lead_id }}">Lead #{{ d.lead_id }}</a></td>
          <td>
            {% if d.stage == 'closed_won' %}
            <span class="badge bg-green-lt">{{ d.stage|replace('_', ' ') }}</span>
            {% elif d.stage == 'closed_lost' %}
            <span class="badge bg-red-lt">{{ d.stage|replace('_', ' ') }}</span>
            {% elif d.stage == 'interested' or d.stage == 'meeting_booked' %}
            <span class="badge bg-blue-lt">{{ d.stage|replace('_', ' ') }}</span>
            {% else %}
            <span class="badge bg-secondary-lt">{{ d.stage|replace('_', ' ') }}</span>
            {% endif %}
          </td>
          <td>${{ "%.0f"|format(d.value) }}</td>
          <td>{{ d.notes[:50] }}{% if d.notes|length > 50 %}...{% endif %}</td>
          <td>{{ d.created_at[:10] if d.created_at else '-' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="text-muted">No deals found</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
